==========================================
Step 4: Train SNPE - IMPROVED
==========================================
Host: compute-1-12
OMP_NUM_THREADS = 32
CWD: /user1/supriyo/ml_project/SBI_step_by_step/UGMRT_500h
Python: /user1/supriyo/miniconda3/envs/ml_project/bin/python
Conda env: ml_project           * /user1/supriyo/miniconda3/envs/ml_project
==========================================

IMPROVED HYPERPARAMETERS:
  - batch_size: 32 (was 16)
  - learning_rate: 5e-4 (was 1e-4)
  - num_epochs: 300 (was 100)
  - weight_decay: 1e-5
  - Expected: SMOOTH, well-defined posteriors
==========================================

Using device: cpu

============================================================
STEP 4: TRAIN SNPE (Neural Posterior Estimation)
============================================================

1. Loading split dataset...
   theta_train shape: torch.Size([427, 2])
   x_train shape: torch.Size([427, 2762])
   theta_val shape: torch.Size([107, 2])
   x_val shape: torch.Size([107, 2762])

   Dataset summary:
   - Training samples: 427
   - Validation samples: 107
   - Input dimension (frequencies): 2762
   - Parameter dimension: 2 (xHI, fX)

2. Defining prior...
   Prior: xHI ∈ [0, 1], fX ∈ [-4, 1]

3. Initializing SNPE...

4. Training with IMPROVED hyperparameters:
   batch_size: 32 (was 16)
   learning_rate: 0.0005 (was 1e-4)
   num_epochs: 300 (was 100)
   → Expected: SMOOTHER, well-defined posteriors

5. Training neural posterior...
   This will take 30-60 minutes on CPU...
   Improved hyperparameters should yield better posteriors...
 Training neural network. Epochs trained: 1 Training neural network. Epochs trained: 2 Training neural network. Epochs trained: 3 Training neural network. Epochs trained: 4 Training neural network. Epochs trained: 5 Training neural network. Epochs trained: 6 Training neural network. Epochs trained: 7 Training neural network. Epochs trained: 8 Training neural network. Epochs trained: 9 Training neural network. Epochs trained: 10 Training neural network. Epochs trained: 11 Training neural network. Epochs trained: 12 Training neural network. Epochs trained: 13 Training neural network. Epochs trained: 14 Training neural network. Epochs trained: 15 Training neural network. Epochs trained: 16 Training neural network. Epochs trained: 17 Training neural network. Epochs trained: 18 Training neural network. Epochs trained: 19 Training neural network. Epochs trained: 20 Training neural network. Epochs trained: 21 Training neural network. Epochs trained: 22 Training neural network. Epochs trained: 23 Training neural network. Epochs trained: 24 Training neural network. Epochs trained: 25 Training neural network. Epochs trained: 26 Training neural network. Epochs trained: 27 Training neural network. Epochs trained: 28 Training neural network. Epochs trained: 29 Training neural network. Epochs trained: 30 Training neural network. Epochs trained: 31 Training neural network. Epochs trained: 32 Training neural network. Epochs trained: 33 Training neural network. Epochs trained: 34 Training neural network. Epochs trained: 35 Training neural network. Epochs trained: 36 Training neural network. Epochs trained: 37 Training neural network. Epochs trained: 38 Training neural network. Epochs trained: 39 Training neural network. Epochs trained: 40 Training neural network. Epochs trained: 41 Training neural network. Epochs trained: 42 Training neural network. Epochs trained: 43 Training neural network. Epochs trained: 44 Training neural network. Epochs trained: 45 Training neural network. Epochs trained: 46 Training neural network. Epochs trained: 47 Training neural network. Epochs trained: 48 Training neural network. Epochs trained: 49 Training neural network. Epochs trained: 50 Training neural network. Epochs trained: 51 Training neural network. Epochs trained: 52 Training neural network. Epochs trained: 53 Training neural network. Epochs trained: 54 Training neural network. Epochs trained: 55 Training neural network. Epochs trained: 56 Training neural network. Epochs trained: 57 Training neural network. Epochs trained: 58 Training neural network. Epochs trained: 59 Training neural network. Epochs trained: 60 Training neural network. Epochs trained: 61 Training neural network. Epochs trained: 62 Training neural network. Epochs trained: 63 Training neural network. Epochs trained: 64 Training neural network. Epochs trained: 65 Training neural network. Epochs trained: 66 Training neural network. Epochs trained: 67 Training neural network. Epochs trained: 68 Training neural network. Epochs trained: 69 Training neural network. Epochs trained: 70 Training neural network. Epochs trained: 71 Training neural network. Epochs trained: 72 Training neural network. Epochs trained: 73 Training neural network. Epochs trained: 74 Training neural network. Epochs trained: 75 Training neural network. Epochs trained: 76 Training neural network. Epochs trained: 77 Training neural network. Epochs trained: 78 Training neural network. Epochs trained: 79 Training neural network. Epochs trained: 80 Training neural network. Epochs trained: 81 Training neural network. Epochs trained: 82 Training neural network. Epochs trained: 83 Training neural network. Epochs trained: 84 Training neural network. Epochs trained: 85 Training neural network. Epochs trained: 86 Training neural network. Epochs trained: 87 Training neural network. Epochs trained: 88 Training neural network. Epochs trained: 89 Training neural network. Epochs trained: 90 Training neural network. Epochs trained: 91 Training neural network. Epochs trained: 92 Training neural network. Epochs trained: 93 Training neural network. Epochs trained: 94 Training neural network. Epochs trained: 95 Training neural network. Epochs trained: 96 Training neural network. Epochs trained: 97 Training neural network. Epochs trained: 98 Training neural network. Epochs trained: 99 Training neural network. Epochs trained: 100 Training neural network. Epochs trained: 101 Training neural network. Epochs trained: 102 Training neural network. Epochs trained: 103 Training neural network. Epochs trained: 104 Training neural network. Epochs trained: 105 Training neural network. Epochs trained: 106 Training neural network. Epochs trained: 107 Training neural network. Epochs trained: 108 Neural network successfully converged after 108 epochs.
        -------------------------
        ||||| ROUND 1 STATS |||||:
        -------------------------
        Epochs trained: 108
        Best validation performance: 0.0363
        -------------------------
        

✅ Training complete!

6. Saving posterior...
   Saved to: /user1/supriyo/ml_project/SBI_step_by_step/UGMRT_500h/Outputs/posterior_snpe.pt
   Metadata saved to: /user1/supriyo/ml_project/SBI_step_by_step/UGMRT_500h/Outputs/metadata_train.pkl

============================================================
✅ STEP 4 COMPLETE - IMPROVED TRAINING!
============================================================

Training Summary:
  - Trained on: 427 samples
  - Validated on: 107 samples
  - Model saved: /user1/supriyo/ml_project/SBI_step_by_step/UGMRT_500h/Outputs/posterior_snpe.pt
  - Hyperparameters: IMPROVED for smooth posteriors
  - batch_size: 32, lr: 0.0005, epochs: 300

Expected results:
  - Smoother contours in posterior distributions
  - Better-defined 1σ and 2σ credible intervals
  - Professional appearance similar to paper figures

Next: Run Step 5 for posterior inference on 5 test points

✅ Log saved to: /user1/supriyo/ml_project/SBI_step_by_step/UGMRT_500h/Outputs/training_log.txt

==========================================
Training job completed!
Check training_log.txt for details
==========================================
